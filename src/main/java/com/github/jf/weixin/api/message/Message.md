#消息管理模块MD文件



##接收普通消息
>​当普通微信用户向公众账号发消息时，微信服务器将POST消息的XML数据包到开发者填写的URL上。

请注意：
1、关于重试的消息排重，推荐使用msgid排重。
2、微信服务器在五秒内收不到响应会断掉连接，并且重新发起请求，总共重试三次。假如服务器无法保证在五秒内处理并回复，可以直接回复空串，微信服务器不会对此作任何处理，并且不会发起重试。详情请见“发送消息-被动回复消息”。
3、为了保证更高的安全保障，开发者可以在公众平台官网的开发者中心处设置消息加密。开启加密后，用户发来的消息会被加密，公众号被动回复用户的消息也需要加密（但开发者通过客服接口等API调用形式向用户发送消息，则不受影响）。关于消息加解密的详细说明，请见“消息加解密说明”。
各消息类型的推送XML数据包结构如下：

目录
1 文本消息
2 图片消息
3 语音消息
4 视频消息
5 小视频消息
6 地理位置消息
7 链接消息



##接收事件推送
​>在微信用户和公众号产生交互的过程中，用户的某些操作会使得微信服务器通过事件推送的形式通知到开发者在开发者中心处设置的服务器地址，从而开发者可以获取到该信息。其中，某些事件推送在发生后，是允许开发者回复用户的，某些则不允许，详细说明请见本页末尾的微信推送消息与事件说明。

目录
1 关注/取消关注事件
2 扫描带参数二维码事件
3 上报地理位置事件
4 自定义菜单事件
5 点击菜单拉取消息时的事件推送
6 点击菜单跳转链接时的事件推送


##被动回复用户消息
>当用户发送消息给公众号时（或某些特定的用户操作引发的事件推送时），会产生一个POST请求，开发者可以在响应包（Get）中返回特定XML结构，来对该消息进行响应（现支持回复文本、图片、图文、语音、视频、音乐）。严格来说，发送被动响应消息其实并不是一种接口，而是对微信服务器发过来消息的一次回复。
 
 微信服务器在将用户的消息发给公众号的开发者服务器地址（开发者中心处配置）后，微信服务器在五秒内收不到响应会断掉连接，并且重新发起请求，总共重试三次，如果在调试中，发现用户无法收到响应的消息，可以检查是否消息处理超时。关于重试的消息排重，有msgid的消息推荐使用msgid排重。事件类型消息推荐使用FromUserName + CreateTime 排重。
 
 如果开发者希望增强安全性，可以在开发者中心处开启消息加密，这样，用户发给公众号的消息以及公众号被动回复用户消息都会继续加密（但），详见被动回复消息加解密说明。
 
 假如服务器无法保证在五秒内处理并回复，必须做出下述回复，这样微信服务器才不会对此作任何处理，并且不会发起重试（这种情况下，可以使用客服消息接口进行异步回复），否则，将出现严重的错误提示。详见下面说明：
 
 1、（推荐方式）直接回复success
 2、直接回复空串（指字节长度为0的空字符串，而不是XML结构体中content字段的内容为空）
 一旦遇到以下情况，微信都会在公众号会话中，向用户下发系统提示“该公众号暂时无法提供服务，请稍后再试”：
 
 1、开发者在5秒内未回复任何内容
 2、开发者回复了异常数据，比如JSON数据等
 另外，请注意，回复图片等多媒体消息时需要预先通过素材管理接口上传临时素材到微信服务器，可以使用素材管理中的临时素材，也可以使用永久素材。
 
 各消息类型需要的XML数据包结构如下。
 
 目录
 1 回复文本消息
 2 回复图片消息
 3 回复语音消息
 4 回复视频消息
 5 回复音乐消息
 6 回复图文消息


##消息加解密-方案概述
>公众平台消息体签名及加解密方案概述

公众号消息加解密是公众平台为了进一步加强公众号安全保障，提供的新机制。开发者需注意，公众账号主动调用API的情况将不受影响。只有被动回复用户的消息时，才需要进行消息加解密。具体包括：

1.新增消息体签名验证，用于公众平台和公众账号验证消息体的正确性
2.针对推送给微信公众账号的普通消息和事件消息，以及推送给设备公众账号的设备消息进行加密
3.公众账号对密文消息的回复也要求加密
请开发者查看接入指引和开发者FAQ来接入消息体签名及加解密功能：接入指引，开发者FAQ，若关注技术实现，可查看技术方案：技术方案

启用加解密功能（即选择兼容模式或安全模式）后，公众平台服务器在向公众账号服务器配置地址（可在“开发者中心”修改）推送消息时，URL将新增加两个参数（加密类型和消息体签名），并以此来体现新功能。加密算法采用AES，具体的加解密流程和方案请看接入指引、技术方案和示例代码。

为了配合消息加密功能的上线，并帮助开发者适配新特性，公众平台提供了3种加解密的模式供开发者选择，即明文模式、兼容模式、安全模式(可在“开发者中心”选择相应模式),选择兼容模式和安全模式前，需在开发者中心填写消息加解密密钥EncodingAESKey。

明文模式：维持现有模式，没有适配加解密新特性，消息体明文收发，默认设置为明文模式
兼容模式：公众平台发送消息内容将同时包括明文和密文，消息包长度增加到原来的3倍左右；公众号回复明文或密文均可，不影响现有消息收发；开发者可在此模式下进行调试
安全模式（推荐）：公众平台发送消息体的内容只含有密文，公众账号回复的消息体也为密文，建议开发者在调试成功后使用此模式收发消息
什么是EncodingAESKey？

微信公众平台采用AES对称加密算法对推送给公众帐号的消息体对行加密，EncodingAESKey则是加密所用的秘钥。公众帐号用此秘钥对收到的密文消息体进行解密，回复消息体也用此秘钥加密。

此外，微信公众平台为开发者提供了5种语言的示例代码（包括C++、php、Java、Python和C#版本，../static/assets/a5a22f38cb60228cb32ab61d9e4c414b.zip ）。


##发送客服消息
>当用户和公众号产生特定动作的交互时（具体动作列表请见下方说明），微信将会把消息数据推送给开发者，开发者可以在一段时间内（目前修改为48小时）调用客服接口，通过POST一个JSON数据包来发送消息给普通用户。此接口主要用于客服等有人工消息处理环节的功能，方便开发者为用户提供更加优质的服务。
 
 目前允许的动作列表如下（公众平台会根据运营情况更新该列表，不同动作触发后，允许的客服接口下发消息条数不同，下发条数达到上限后，会遇到错误返回码，具体请见返回码说明页）：
 
 1、用户发送信息
 2、点击自定义菜单（仅有点击推事件、扫码推事件、扫码推事件且弹出“消息接收中”提示框这3种菜单类型是会触发客服接口的）
 3、关注公众号
 4、扫描二维码
 5、支付成功
 6、用户维权
 为了帮助公众号使用不同的客服身份服务不同的用户群体，客服接口进行了升级，开发者可以管理客服账号，并设置客服账号的头像和昵称。该能力针对所有拥有客服接口权限的公众号开放。
 
 另外，请开发者注意，本接口中所有使用到media_id的地方，现在都可以使用素材管理中的永久素材media_id了。
 
##高级群发接口
 >在公众平台网站上，为订阅号提供了每天一条的群发权限，为服务号提供每月（自然月）4条的群发权限。而对于某些具备开发能力的公众号运营者，可以通过高级群发接口，实现更灵活的群发能力。
  
  请注意：
  
  1、对于认证订阅号，群发接口每天可成功调用1次，此次群发可选择发送给全部用户或某个分组；
  2、对于认证服务号虽然开发者使用高级群发接口的每日调用限制为100次，但是用户每月只能接收4条，无论在公众平台网站上，还是使用接口群发，用户每月只能接收4条群发消息，多于4条的群发将对该用户发送失败；
  3、具备微信支付权限的公众号，在使用群发接口上传、群发图文消息类型时，可使用<a>标签加入外链；
  4、开发者可以使用预览接口校对消息样式和排版，通过预览接口可发送编辑好的消息给指定用户校验效果。
  群发图文消息的过程如下：
  
  1、首先，预先将图文消息中需要用到的图片，使用上传图文消息内图片接口，上传成功并获得图片URL
  2、上传图文消息素材，需要用到图片时，请使用上一步获取的图片URL
  3、使用对用户分组的群发，或对OpenID列表的群发，将图文消息群发出去
  4、在上述过程中，如果需要，还可以预览图文消息、查询群发状态，或删除已群发的消息等
  群发图片、文本等其他消息类型的过程如下：
  
  1、如果是群发文本消息，则直接根据下面的接口说明进行群发即可
  2、如果是群发图片、视频等消息，则需要预先通过素材管理接口准备好mediaID
  关于群发时使用is_to_all为true使其进入公众号在微信客户端的历史消息列表：
  
  1、使用is_to_all为true且成功群发，会使得此次群发进入历史消息列表。
  2、为防止异常，认证订阅号在一天内，只能使用is_to_all为true进行群发一次，或者在公众平台官网群发（不管本次群发是对全体还是对某个分组）一次。以避免一天内有2条群发进入历史消息列表。
  3、类似地，服务号在一个月内，使用is_to_all为true群发的次数，加上公众平台官网群发（不管本次群发是对全体还是对某个分组）的次数，最多只能是4次。
  4、设置is_to_all为false时是可以多次群发的，但每个用户只会收到最多4条，且这些群发不会进入历史消息列表。
  另外，请开发者注意，本接口中所有使用到media_id的地方，现在都可以使用素材管理中的永久素材media_id了。请但注意，使用同一个素材群发出去的链接是一样的，这意味着，删除某一次群发，会导致整个链接失效。
  
  目录
  1 上传图文消息内的图片获取URL【订阅号与服务号认证后均可用】
  2 上传图文消息素材【订阅号与服务号认证后均可用】
  3 根据分组进行群发【订阅号与服务号认证后均可用】
  4 根据OpenID列表群发【订阅号不可用，服务号认证后可用】
  5 删除群发【订阅号与服务号认证后均可用】
  6 预览接口【订阅号与服务号认证后均可用】
  7 查询群发消息发送状态【订阅号与服务号认证后均可用】
  8 事件推送群发结果
  
  
##模板消息接口
>模板消息仅用于公众号向用户发送重要的服务通知，只能用于符合其要求的服务场景中，如信用卡刷卡通知，商品购买成功通知等。不支持广告等营销类消息以及其它所有可能对用户造成骚扰的消息。具体模板消息运营规则请读模板消息运营规范
 
 关于使用规则，请注意：
 
 1、所有服务号都可以在功能->添加功能插件处看到申请模板消息功能的入口，但只有认证后的服务号才可以申请模板消息的使用权限并获得该权限；
 2、需要选择公众账号服务所处的2个行业，每月可更改1次所选行业；
 3、在所选择行业的模板库中选用已有的模板进行调用；
 4、每个账号可以同时使用25个模板。
 5、当前每个账号的模板消息的日调用上限为10万次，单个模板没有特殊限制。【2014年11月18日将接口调用频率从默认的日1万次提升为日10万次，可在MP登录后的开发者中心查看】。当账号粉丝数超过10W/100W/1000W时，模板消息的日调用上限会相应提升，以公众号MP后台开发者中心页面中标明的数字为准。
 关于接口文档，请注意：
 
 1、模板消息调用时主要需要模板ID和模板中各参数的赋值内容；
 2、模板中参数内容必须以".DATA"结尾，否则视为保留字；
 3、模板保留符号"{{ }}"。
 目录
 1 设置所属行业
 2 获取设置的行业信息
 3 获得模板ID
 4 获取模板列表
 5 删除模板
 6 发送模板消息
 7 事件推送
 
##获取自动回复规则
>开发者可以通过该接口，获取公众号当前使用的自动回复规则，包括关注后自动回复、消息自动回复（60分钟内触发一次）、关键词自动回复。

请注意：

1、第三方平台开发者可以通过本接口，在旗下公众号将业务授权给你后，立即通过本接口检测公众号的自动回复配置，并通过接口再次给公众号设置好自动回复规则，以提升公众号运营者的业务体验。
2、本接口仅能获取公众号在公众平台官网的自动回复功能中设置的自动回复规则，若公众号自行开发实现自动回复，或通过第三方平台开发者来实现，则无法获取。
3、认证/未认证的服务号/订阅号，以及接口测试号，均拥有该接口权限。
4、从第三方平台的公众号登录授权机制上来说，该接口从属于消息与菜单权限集。
5、本接口中返回的图片/语音/视频未临时素材（临时素材每次获取都不同，3天内有效，通过素材管理-获取临时素材接口来获取这些素材），本接口返回的图文消息为永久素材素材（通过素材管理-获取永久素材接口来获取这些素材）。
